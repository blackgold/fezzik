#!/usr/bin/env ruby

files = {
  "config/deploy.rb" => <<-EOF,
# This is the configuration file for fezzik.
# Define variables here as you would for Vlad the Deployer.
# A full list of variables can be found here:
#     http://hitsquad.rubyforge.org/vlad/doco/variables_txt.html

set :app, "app"
set :deploy_to, "/opt/#\{app\}"
set :release_path, "#\{deploy_to\}/releases/#\{Time.now.strftime("%Y%m%d%H%M")\}"
set :local_path, Dir.pwd
set :user, "root"


# Each destination is a set of machines and configurations to deploy to.
# You can deploy to a destination from the command line with:
#     fez to_dev deploy
#
# :domain can be an array if you are deploying to multiple hosts.
#
# You can set environment variables that will be loaded at runtime on the server
# like this:
#     env :rack_env, "production"

destination :dev do
  set :domain, "#\{user\}@dev.example.com"
end

destination :prod do
  set :domain, "#\{user\}@prod.example.com"
end
  EOF

  "config/recipes/core.rb" => <<-EOF,
# This file contains core tasks that are used to deploy your application to the
# destination servers. This is a decent initial setup, but is completely configurable.

namespace :fezzik do
  task :save_environment do
    system("mkdir -p /tmp/#\{app\}/config")
    File.open("/tmp/#\{app\}/config/environment.rb", "w") do |file|
      @environment.each do |key, value|
        file.puts "#\{key.to_s.upcase\}=\\"#\{value\}\\""
      end
    end
    File.open("/tmp/#\{app\}/config/environment.sh", "w") do |file|
      @environment.each do |key, value|
        file.puts "export #\{key.to_s.upcase\}=\\"#\{value\}\\""
      end
    end
  end

  task :stage do
    puts "staging project in /tmp/#\{app\}"
    system("rm -fr /tmp/#\{app\}")
    system("cp -r #\{local_path\} /tmp/#\{app\}")
    Rake::Task["fezzik:save_environment"].invoke
  end

  remote_task :setup do
    puts "setting up servers"
    run "mkdir -p #\{deploy_to\}/releases"
  end

  remote_task :push => [:stage, :setup] do
    rsync "/tmp/#\{app\}/", "#\{target_host\}:#\{release_path\}"
  end

  remote_task :symlink => :push do
    puts "symlinking current to #\{release_path\}"
    run "cd #\{deploy_to\} && ln -fns #\{release_path\} current"
  end

  remote_task :start do
    puts "starting from #\{release_path\}"
    run "cd #\{current_path\} && source config/environment.sh" +
        " && ./bin/run_#\{app\}.sh"
  end

  remote_task :stop do
    puts "stopping app"
    # Replace YOUR_APP_NAME with whatever is run from your bin/run_app.sh file.
    # run "(kill -9 `ps aux | grep 'YOUR_APP_NAME' | grep -v grep | awk '\{print $2\}'` || true)"
  end

  remote_task :restart do
    Rake::Task["fezzik:stop"].invoke
    Rake::Task["fezzik:start"].invoke
  end

  task :deploy => [:symlink, :restart] do
    puts "#\{app\} deployed!"
  end
end
  EOF

  "bin/run_app.sh" => <<-EOF
#!/bin/sh
# This file will be called to start your application.
  EOF
}

system("mkdir -p config/recipes")
system("mkdir -p bin")

files.each do |filename, content|
  if File.exists?(filename) && ARGV[0] != "-f"
    puts "    [skip] #{filename} already exists"
  else
    puts "    [new] #{filename} created"
    File.open(filename, "w") { |file| file.write(content) }
    if filename == "bin/run_app.sh"
      system("chmod a+x bin/run_app.sh")
    end
  end
end

puts "    [done]"
