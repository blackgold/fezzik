#!/usr/bin/env ruby

require "rubygems"
require "rake"
require "colorize"
require "fezzik"

# TODO: Add a handy "fez init" command to set up a basic deployable directory structure
# TODO: Think about how to do domain overrides better
# TODO: Add Fezzik::DSL so you can say env or destination instead of Fezzik.env, Fezzik.destination

Fezzik.activated = true

def usage
  <<-EOF
Version #{Fezzik::VERSION}
fez <destination> <tasks>  # Run deployment tasks on destination servers
fez get <tasks>            # Download tasks to use in your project
fez -T                     # Display all tasks
  EOF
end

def print_usage_and_exit
  puts usage
  exit 1
end

def display_tasks_and_exit
  Rake.application.init
  Rake.application.load_rakefile
  Rake.application.options.show_task_pattern = /^fezzik:/
  output = Fezzik::Util.capture_output { Rake.application.display_tasks_and_comments }
  output.gsub!(/^rake fezzik:/, "fez <destination> ")
  puts output
  exit 0
end

TASKS_URL = "https://raw.github.com/dmacdougall/fezzik/master/tasks"
def download_tasks_and_exit
  ARGV[1..-1].each do |task|
    task += ".rake" unless task =~ /\.rake$/
    system("curl -f #{TASKS_URL}/#{task} -o #{task} > /dev/null 2>&1")
    if $? == 0
      puts "    [new]".green + "  #{task}"
    else
      puts "    [fail]".red + " #{task}"
    end
  end
  exit 0
end

def prepend_user_to_domains
  set :domain, Array(domain).map { |d| (defined?(user) && !d.include?("@")) ? "#{user}@#{d}" : d }
end

# Blocks passed to this function will ensure `domain` is always an Array. In addition, if `user` is set it
# will automatically prepend the value of `user` to the front of any domains missing a username. This allows a
# fezzik user to write the following in their configuration and have it "just work":
#     set :domain, ["example.com", "test@example2.com"]
#     set :user, "root"
# `domain` will be equal to ["root@example.com", "test@example2.com"]
def with_prepended_user(&block)
  old_domain = domain
  begin
    set :domain, Array(domain).map { |d| (defined?(user) && !d.include?("@")) ? "#{user}@#{d}" : d }
    block.call
  ensure
    set :domain, old_domain
  end
end

def load_configuration
  ENV["fezzik_destination"] = ARGV[0]
  Fezzik.init
  Rake.application.init
  Rake.application.load_rakefile
end

def run_fezzik_tasks
  load_configuration
  begin
    host_list = Array(domain).join("\n    ")
    puts "Targeting hosts:"
    puts "    #{host_list}"
  rescue Rake::ConfigurationError => e
    puts "Invalid destination: #{Fezzik.target_destination}"
    puts "Make sure this destination is configured and includes `set :domain, \"yourdomain.com\"`"
    puts "[fail]".red
    exit 1
  end
  begin
    tasks = ARGV[1..-1]
    tasks.each do |task_with_params|
      task_name, params = Fezzik::Util.split_task_and_params(task_with_params)
      task_name = task_name.to_sym
      task = Rake::Task["fezzik:#{task_name}"]
      if Fezzik.task_roles[task_name].nil?
        with_prepended_user { task.invoke(params) }
      else
        Fezzik.task_roles[task_name].each do |role|
          Fezzik.with_role(role) do
            with_prepended_user { task.invoke(params) }
          end
        end
      end
    end
    puts "[success]".green
  rescue SystemExit, Rake::CommandFailedError => e
    puts "[fail]".red
    exit 1
  rescue StandardError => e
    puts e.message
    puts e.backtrace
    puts "[fail]".red
    fail
  end
end

case ARGV[0]
when nil, "-h" then print_usage_and_exit
when "-T" then display_tasks_and_exit
when "get" then download_tasks_and_exit
else run_fezzik_tasks
end
